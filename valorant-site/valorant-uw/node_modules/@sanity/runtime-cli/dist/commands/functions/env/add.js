import { Args, Command } from '@oclif/core';
import Spinner from 'yocto-spinner';
import { readBlueprintOnDisk } from '../../../actions/blueprints/blueprint.js';
import { update } from '../../../actions/functions/env/update.js';
import config from '../../../config.js';
import { red } from '../../../utils/display/colors.js';
import { findFunctionByName } from '../../../utils/find-function.js';
export default class Add extends Command {
    static args = {
        name: Args.string({ description: 'The name of the Sanity Function', required: true }),
        key: Args.string({ description: 'The name of the environment variable', required: true }),
        value: Args.string({ description: 'The value of the environment variable', required: true }),
    };
    static description = 'Add or set the value of an environment variable for a Sanity function';
    static examples = [
        '<%= config.bin %> <%= command.id %> MyFunction API_URL https://api.example.com/',
    ];
    async run() {
        const { args } = await this.parse(Add);
        const spinner = Spinner({
            text: `Updating "${args.key}" environment variable in "${args.name}"`,
        }).start();
        const { deployedStack } = await readBlueprintOnDisk({ getStack: true, token: config.token });
        if (!deployedStack)
            this.error('Stack not found'); // returns
        const { projectId } = deployedStack;
        const { externalId } = findFunctionByName(deployedStack, args.name);
        const result = await update(externalId, args.key, args.value, {
            token: config.token,
            projectId,
        });
        if (result.ok) {
            spinner.success(`Update of ${args.key} succeeded`);
        }
        else {
            spinner.error(`${red('Failed')} to update ${args.key}`);
            this.log(`Error: ${result.error || 'Unknown error'}`);
        }
    }
}
