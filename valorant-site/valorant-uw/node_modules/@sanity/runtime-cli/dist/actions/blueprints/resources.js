import { mkdirSync, writeFileSync } from 'node:fs';
import { existsSync } from 'node:fs';
import { dirname, join } from 'node:path';
import { cwd } from 'node:process';
import { addResourceToBlueprint } from './blueprint.js';
const DEFAULT_FUNCTION_TEMPLATE = /*js*/ `export async function handler({context, event}) {
  const time = new Date().toLocaleTimeString()
  console.log(\`ðŸ‘‹ Your Sanity Function was called at \${time}\`)
}`;
const DEFAULT_PACKAGE_JSON = `{
  "name": "<<NAME>>",
  "type": "module",
  "main": "index.js"
}`;
/**
 * Creates a new function resource file and adds it to the blueprint
 */
export function createFunctionResource(options) {
    const { name, type, displayName = name, blueprintFilePath } = options;
    let workingDir = cwd();
    if (blueprintFilePath) {
        if (!existsSync(blueprintFilePath)) {
            throw Error(`Blueprint file not found: ${blueprintFilePath}`);
        }
        workingDir = dirname(blueprintFilePath);
    }
    // Ensure functions directory exists
    const functionsDir = join(workingDir, 'functions');
    if (!existsSync(functionsDir)) {
        mkdirSync(functionsDir, { recursive: true });
    }
    // Create function directory
    const functionDir = join(functionsDir, name);
    if (!existsSync(functionDir)) {
        mkdirSync(functionDir, { recursive: true });
    }
    // Create index.js with default template
    const indexPath = join(functionDir, 'index.js');
    writeFileSync(indexPath, DEFAULT_FUNCTION_TEMPLATE);
    // Create package.json
    const packagePath = join(functionDir, 'package.json');
    const packageContent = DEFAULT_PACKAGE_JSON.replace('<<NAME>>', name);
    writeFileSync(packagePath, packageContent);
    // Create resource definition
    const resourceJson = {
        displayName,
        name,
        type: `sanity.function.${type}`,
        src: `functions/${name}`,
    };
    // Add to blueprint or return for manual addition
    const resource = addResourceToBlueprint({ blueprintFilePath, resource: resourceJson });
    return {
        filePath: indexPath,
        resourceAdded: !resource, // If resource is null, it was added to blueprint
        resource: resource || resourceJson,
    };
}
